<form nz-form [formGroup]="deliveryNoteForm" (ngSubmit)="onSubmit()">
  <div class="form-header">
    <div class="form-row">
      <nz-form-item class="form-item-half">
        <nz-form-label nzRequired>Client</nz-form-label>
        <nz-form-control nzErrorTip="Please select a client">
          <nz-select
            formControlName="clientId"
            nzPlaceHolder="Select client"
            nzAllowClear
            [nzLoading]="isLoadingClients">
            <nz-option 
              *ngFor="let client of clients" 
              [nzValue]="client.id" 
              [nzLabel]="client.name">
            </nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item class="form-item-half">
        <nz-form-label nzRequired>Delivery Date</nz-form-label>
        <nz-form-control nzErrorTip="Please select delivery date">
          <nz-date-picker
            formControlName="deliveryDate"
            nzFormat="yyyy-MM-dd"
            style="width: 100%;">
          </nz-date-picker>
        </nz-form-control>
      </nz-form-item>
    </div>

    <div class="form-row">
      <nz-form-item class="form-item-half">
        <nz-form-label>Delivery Address</nz-form-label>
        <nz-form-control>
          <textarea
            nz-input
            formControlName="deliveryAddress"
            placeholder="Enter delivery address"
            rows="3">
          </textarea>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item class="form-item-half">
        <nz-form-label nzRequired>Status</nz-form-label>
        <nz-form-control nzErrorTip="Please select status">
          <nz-select
            formControlName="status"
            nzPlaceHolder="Select status">
            <nz-option 
              *ngFor="let option of statusOptions" 
              [nzValue]="option.value" 
              [nzLabel]="option.label">
            </nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>
    </div>

    <nz-form-item>
      <nz-form-label>Notes</nz-form-label>
      <nz-form-control>
        <textarea
          nz-input
          formControlName="notes"
          placeholder="Enter notes"
          rows="2">
        </textarea>
      </nz-form-control>
    </nz-form-item>
  </div>

  <div class="items-section">
    <div class="items-header">
      <h3>Items</h3>
      <button 
        type="button" 
        nz-button 
        nzType="dashed" 
        (click)="addItem()">
        <span nz-icon nzType="plus"></span>
        Add Item
      </button>
    </div>

    <div formArrayName="items" class="items-container">
      <div 
        *ngFor="let item of items.controls; let i = index" 
        [formGroupName]="i" 
        class="item-row">
        
        <div class="item-fields">
          <nz-form-item class="product-field">
            <nz-form-label [nzRequired]="true">Product</nz-form-label>
            <nz-form-control nzErrorTip="Product name is required">
              <input
                #productInput
                nz-input
                formControlName="productName"
                placeholder="Enter product name"
                [nzAutocomplete]="auto"
                (input)="onProductSearch($event)" />
              <nz-autocomplete 
                #auto 
                [nzBackfill]="true"
                (selectionChange)="onProductSelect($event, i)">
                <nz-auto-option 
                  *ngFor="let product of productOptions" 
                  [nzValue]="product.name"
                  [nzLabel]="product.name">
                  <div>
                    <strong>{{ product.name }}</strong>
                    <div class="product-description">{{ product.description }}</div>
                  </div>
                </nz-auto-option>
              </nz-autocomplete>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item class="description-field">
            <nz-form-label>Description</nz-form-label>
            <nz-form-control>
              <input
                nz-input
                formControlName="description"
                placeholder="Enter description" />
            </nz-form-control>
          </nz-form-item>

          <nz-form-item class="quantity-field">
            <nz-form-label [nzRequired]="true">Quantity</nz-form-label>
            <nz-form-control nzErrorTip="Quantity is required">
              <nz-input-number
                formControlName="quantity"
                [nzMin]="1"
                [nzStep]="1">
              </nz-input-number>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item class="delivered-quantity-field">
            <nz-form-label>Delivered</nz-form-label>
            <nz-form-control>
              <nz-input-number
                formControlName="deliveredQuantity"
                [nzMin]="0"
                [nzStep]="1">
              </nz-input-number>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item class="price-field">
            <nz-form-label [nzRequired]="true">Unit Price</nz-form-label>
            <nz-form-control nzErrorTip="Unit price is required">
              <nz-input-number
                formControlName="unitPrice"
                [nzMin]="0"
                [nzStep]="0.001"
                [nzPrecision]="3"
                [nzFormatter]="currencyFormatter"
                [nzParser]="currencyParser">
              </nz-input-number>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item class="total-field">
            <nz-form-label>Net Total</nz-form-label>
            <nz-form-control>
              <nz-input-number
                formControlName="totalPrice"
                [nzDisabled]="true"
                [nzPrecision]="3"
                [nzFormatter]="currencyFormatter">
              </nz-input-number>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item class="vat-info-field" *ngIf="getSelectedProduct(i)?.vatRate">
            <nz-form-label>VAT ({{ getSelectedProduct(i)?.vatRate?.percentage }}%)</nz-form-label>
            <nz-form-control>
              <nz-input-number
                [ngModel]="getVatAmount(i)"
                [nzDisabled]="true"
                [nzPrecision]="3"
                [nzFormatter]="currencyFormatter">
              </nz-input-number>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item class="gross-total-field" *ngIf="getSelectedProduct(i)?.vatRate">
            <nz-form-label>Gross Total</nz-form-label>
            <nz-form-control>
              <nz-input-number
                [ngModel]="getItemGrossTotal(i)"
                [nzDisabled]="true"
                [nzPrecision]="3"
                [nzFormatter]="currencyFormatter">
              </nz-input-number>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div class="item-actions">
          <button 
            type="button" 
            nz-button 
            nzType="text" 
            nzDanger
            (click)="removeItem(i)"
            [disabled]="items.length === 1">
            <span nz-icon nzType="delete"></span>
          </button>
        </div>
      </div>
    </div>

    <div class="total-section">
      <div class="total-breakdown">
        <div class="total-line">
          <span>Net Total: {{ getNetTotal() | currency:'EUR':'symbol':'1.3-3' }}</span>
        </div>
        <div class="total-line" *ngIf="getTotalVatAmount() > 0">
          <span>VAT Total: {{ getTotalVatAmount() | currency:'EUR':'symbol':'1.3-3' }}</span>
        </div>
        <div class="total-line total-amount">
          <strong>Gross Total: {{ getGrossTotal() | currency:'EUR':'symbol':'1.3-3' }}</strong>
        </div>
      </div>
    </div>
  </div>

  <div class="form-actions">
    <button type="button" nz-button (click)="onCancel()">Cancel</button>
    <button type="submit" nz-button nzType="primary">Save Delivery Note</button>
  </div>
</form> 