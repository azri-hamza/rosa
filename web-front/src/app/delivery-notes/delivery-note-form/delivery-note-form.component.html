<form nz-form [formGroup]="deliveryNoteForm" (ngSubmit)="onSubmit()">
  <div class="form-header">
    <div class="form-row">
      <nz-form-item class="form-item-half">
        <nz-form-label nzRequired>Client</nz-form-label>
        <nz-form-control nzErrorTip="Please select a client">
          <nz-select
            formControlName="clientId"
            nzPlaceHolder="Search and select client"
            nzAllowClear
            nzShowSearch
            nzServerSearch
            [nzLoading]="isLoadingClients"
            [nzFilterOption]="nzFilterOption"
            (nzOpenChange)="onClientDropdownOpenChange($event)"
            (nzOnSearch)="onClientSearch($event)">
            <nz-option 
              *ngFor="let client of clients" 
              [nzValue]="client.id" 
              [nzLabel]="client.name">
              <div class="client-option">
                <div class="client-name">{{ client.name }}</div>
                <div class="client-details" *ngIf="client.phoneNumber || client.address">
                  <span *ngIf="client.phoneNumber" class="client-phone">{{ client.phoneNumber }}</span>
                  <span *ngIf="client.address" class="client-address">{{ client.address }}</span>
                </div>
              </div>
            </nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item class="form-item-half">
        <nz-form-label nzRequired>Delivery Date</nz-form-label>
        <nz-form-control nzErrorTip="Please select delivery date">
          <nz-date-picker
            formControlName="deliveryDate"
            nzFormat="yyyy-MM-dd"
            style="width: 100%;">
          </nz-date-picker>
        </nz-form-control>
      </nz-form-item>
    </div>

    <div class="form-row">
      <nz-form-item class="form-item-half">
        <nz-form-label>Delivery Address</nz-form-label>
        <nz-form-control>
          <textarea
            nz-input
            formControlName="deliveryAddress"
            placeholder="Enter delivery address"
            rows="3">
          </textarea>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item class="form-item-half">
        <nz-form-label nzRequired>Status</nz-form-label>
        <nz-form-control nzErrorTip="Please select status">
          <nz-select
            formControlName="status"
            nzPlaceHolder="Select status">
            <nz-option 
              *ngFor="let option of statusOptions" 
              [nzValue]="option.value" 
              [nzLabel]="option.label">
            </nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>
    </div>

    <nz-form-item>
      <nz-form-label>Notes</nz-form-label>
      <nz-form-control>
        <textarea
          nz-input
          formControlName="notes"
          placeholder="Enter notes"
          rows="2">
        </textarea>
      </nz-form-control>
    </nz-form-item>
  </div>

  <div class="items-section">
    <div class="items-header">
      <h3>Items</h3>
      <button 
        type="button" 
        nz-button 
        nzType="dashed" 
        (click)="addItem()">
        <span nz-icon nzType="plus"></span>
        Add Item
      </button>
    </div>

    <div class="items-table-container">
      <table class="items-table">
        <thead>
          <tr>
            <th class="product-col">Product</th>
            <th class="description-col">Description</th>
            <th class="quantity-col">Ordered</th>
            <th class="delivered-col">Delivered</th>
            <th class="price-col">Unit Price</th>
            <th class="discount-col">Discount %</th>
            <th class="net-total-col">Net Total</th>
            <th class="vat-amount-col">VAT Amount</th>
            <th class="gross-total-col">Gross Total</th>
            <th class="actions-col">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (item of items.controls; track $index) {
            <tr class="item-row">
              <!-- Product -->
              <td class="product-cell">
                <div class="product-info">
                  <strong>{{ item.get('productName')?.value }}</strong>
                </div>
              </td>

              <!-- Description -->
              <td class="description-cell">
                <div class="description-text">
                  {{ item.get('description')?.value || '-' }}
                </div>
              </td>

              <!-- Ordered Quantity -->
              <td class="quantity-cell">
                <div class="quantity-display">
                  {{ item.get('quantity')?.value }}
                </div>
              </td>

              <!-- Delivered Quantity -->
              <td class="delivered-cell">
                <div class="delivered-display">
                  {{ item.get('deliveredQuantity')?.value }}
                </div>
              </td>

              <!-- Unit Price -->
              <td class="price-cell">
                <div class="price-display">
                  {{ item.get('unitPrice')?.value | currency:'TND':'symbol':'1.3-3' }}
                </div>
              </td>

              <!-- Discount Percentage -->
              <td class="discount-cell">
                <div class="discount-display">
                  {{ item.get('discountPercentage')?.value }}%
                </div>
              </td>

              <!-- Net Total -->
              <td class="net-total-cell">
                <div class="total-display">
                  {{ item.get('totalPrice')?.value | currency:'TND':'symbol':'1.3-3' }}
                </div>
              </td>

              <!-- VAT Amount -->
              <td class="vat-amount-cell">
                <div class="vat-display">
                  {{ item.get('vatAmount')?.value | currency:'TND':'symbol':'1.3-3' }}
                </div>
              </td>

              <!-- Gross Total -->
              <td class="gross-total-cell">
                <div class="gross-display">
                  {{ item.get('grossTotalPrice')?.value | currency:'TND':'symbol':'1.3-3' }}
                </div>
              </td>

              <!-- Actions -->
              <td class="actions-cell">
                <button 
                  type="button" 
                  nz-button 
                  nzType="link" 
                  nzSize="small"
                  (click)="editItem($index)"
                  title="Edit item">
                  <span nz-icon nzType="edit"></span>
                </button>
                <button 
                  type="button" 
                  nz-button 
                  nzType="link" 
                  nzSize="small"
                  nzDanger
                  (click)="removeItem($index)"
                  title="Delete item">
                  <span nz-icon nzType="delete"></span>
                </button>
              </td>
            </tr>
          } @empty {
            <tr class="empty-state">
              <td colspan="10" class="empty-cell">
                <div class="empty-content">
                  <span nz-icon nzType="inbox" class="empty-icon"></span>
                  <p class="empty-text">No items added yet</p>
                  <p class="empty-subtext">Click "Add Item" to add products to this delivery note</p>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Global Discount Section -->
    <div class="global-discount-section">
      <h4>Global Discount</h4>
      <div class="global-discount-row">
        <nz-form-item class="global-discount-item">
          <nz-form-label>Global Discount %</nz-form-label>
          <nz-form-control [nzErrorTip]="'Please enter a valid discount percentage'">
            <nz-input-number
              formControlName="globalDiscountPercentage"
              [nzMin]="0"
              [nzMax]="100"
              [nzStep]="1"
              [nzPrecision]="2"
              placeholder="0.00"
              nz-tooltip
              nzTooltipTitle="Primary global discount field - calculations are based on this percentage">
            </nz-input-number>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item class="global-discount-item">
          <nz-form-label>Global Discount Amount</nz-form-label>
          <nz-form-control [nzErrorTip]="'Helper field - enter amount to calculate percentage'">
            <nz-input-number
              formControlName="globalDiscountAmount"
              [nzMin]="0"
              [nzPrecision]="3"
              [nzFormatter]="currencyFormatter"
              [nzParser]="currencyParser"
              placeholder="â‚¬ 0.000"
              nz-tooltip
              nzTooltipTitle="Helper field - enter a discount amount to automatically calculate the corresponding percentage"
              class="helper-field">
            </nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>

    <div class="total-section">
      <div class="total-breakdown">
        <div class="total-line">
          <span>Net Total (before global discount): {{ getNetTotal() | currency:'EUR':'symbol':'1.3-3' }}</span>
        </div>
        <div class="total-line" *ngIf="getGlobalDiscountAmount() > 0">
          <span>Global Discount: -{{ getGlobalDiscountAmount() | currency:'EUR':'symbol':'1.3-3' }}</span>
        </div>
        <div class="total-line">
          <span>Net Total (after global discount): {{ getNetTotalAfterGlobalDiscount() | currency:'EUR':'symbol':'1.3-3' }}</span>
        </div>
        <div class="total-line" *ngIf="getTotalVatAmount() > 0">
          <span>VAT Total: {{ getTotalVatAmount() | currency:'EUR':'symbol':'1.3-3' }}</span>
        </div>
        <div class="total-line total-amount">
          <strong>Gross Total: {{ getGrossTotal() | currency:'EUR':'symbol':'1.3-3' }}</strong>
        </div>
      </div>
    </div>
  </div>

  <div class="form-actions">
    <button type="button" nz-button (click)="onCancel()">Cancel</button>
    <button type="submit" nz-button nzType="primary">Save Delivery Note</button>
  </div>
</form> 